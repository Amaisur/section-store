{% comment %} Enhanced swatch logic: use trigger for color, show value for others. On option change, update main image and price. {% endcomment %}
{% comment %} Add tooltips to all swatches (color and text) showing the value on hover/focus. {% endcomment %}
{% comment %} Add switch trigger: if option.name matches a block trigger, show swatch; otherwise, show pill with value. Both have tooltips. {% endcomment %}
{% comment %} Add swatch trigger setting and ensure first option is selected by default. {% endcomment %}

{% assign el_product = all_products[section.settings.featured_product] %}

<style>
  .el-featured-product-section {
    background: #fff;
    border-radius: 2.5rem;
    padding: 2rem 40px;
    margin: 2rem auto;
    max-width: 1200px;
    width: 100%;
    box-sizing: border-box;
    display: flex;
    gap: 3rem;
    align-items: flex-start;
  }
  .el-featured-product-image {
    flex: 1 1 40%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f4f1ef;
    border-radius: 2rem;
    padding: 2rem;
  }
  .el-featured-product-info {
    flex: 1 1 60%;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  .el-featured-product-title {
    font-size: 2.5rem;
    font-weight: 800;
    margin-bottom: 0.5rem;
  }
  .el-featured-product-reviews {
    color: #bc9bb2;
    font-size: 1rem;
    margin-bottom: 1rem;
  }
  .el-featured-product-desc {
    font-size: 1.1rem;
    color: #333;
    margin-bottom: 1rem;
  }
  .el-featured-product-features {
    margin-bottom: 1rem;
  }
  .el-featured-product-feature {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
    margin-bottom: 0.3rem;
  }
  .el-featured-product-options {
    margin-bottom: 1.5rem;
  }
  .el-featured-product-option-label {
    font-weight: 700;
    margin-bottom: 0.3rem;
    display: block;
  }
  .el-featured-product-swatches {
    display: flex;
    gap: 0.7rem;
    margin-bottom: 1rem;
  }
  .el-featured-product-swatch {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 2px solid #bc9bb2;
    background: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: border 0.2s;
    position: relative;
  }
  .el-featured-product-swatch.selected {
    border: 3px solid #bc9bb2;
    box-shadow: 0 0 0 2px #f4f1ef;
  }
  .el-featured-product-swatch-text {
    font-size: 1rem;
    font-weight: 600;
    color: #181818;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 2px solid #bc9bb2;
    background: #fff;
    cursor: pointer;
    transition: border 0.2s;
    position: relative;
    display: none;
  }
  .el-featured-product-swatch-text.selected {
    border: 3px solid #bc9bb2;
    box-shadow: 0 0 0 2px #f4f1ef;
    display: none;
  }
  .el-featured-product-pill {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 40px;
    height: 32px;
    padding: 0 1.1rem;
    border-radius: 1.2rem;
    border: 2px solid #bc9bb2;
    background: #fff;
    font-size: 1rem;
    font-weight: 600;
    color: #181818;
    cursor: pointer;
    margin-right: 0.2rem;
    position: relative;
    transition: border 0.2s, background 0.2s;
  }
  .el-featured-product-pill.selected {
    border: 3px solid #bc9bb2;
    background: #f4f1ef;
    box-shadow: 0 0 0 2px #f4f1ef;
  }
  /* Tooltip styles */
  .el-featured-product-swatch,
  .el-featured-product-pill {
    position: relative;
  }
  .el-featured-product-tooltip {
    visibility: hidden;
    opacity: 0;
    background: #181818;
    color: #fff;
    text-align: center;
    border-radius: 0.5rem;
    padding: 0.3rem 0.7rem;
    position: absolute;
    z-index: 10;
    left: 50%;
    top: -2.2rem;
    transform: translateX(-50%);
    font-size: 0.95rem;
    pointer-events: none;
    transition: opacity 0.15s;
    white-space: nowrap;
  }
  .el-featured-product-swatch:hover .el-featured-product-tooltip,
  .el-featured-product-swatch:focus .el-featured-product-tooltip,
  .el-featured-product-swatch:focus-visible .el-featured-product-tooltip,
  .el-featured-product-pill:hover .el-featured-product-tooltip,
  .el-featured-product-pill:focus .el-featured-product-tooltip,
  .el-featured-product-pill:focus-visible .el-featured-product-tooltip {
    visibility: visible;
    opacity: 1;
  }
  .el-featured-product-price {
    font-size: 2rem;
    font-weight: 700;
    color: #181818;
    margin-bottom: 1rem;
  }
  .el-featured-product-atc-btn {
    background: #bc9bb2;
    color: #fff;
    border: none;
    border-radius: 2rem;
    padding: 1rem 2.5rem;
    font-size: 1.2rem;
    font-weight: 700;
    cursor: pointer;
    margin-bottom: 1rem;
    transition: background 0.2s;
  }
  .el-featured-product-atc-btn:active {
    background: #a07c9b;
  }
  .el-featured-product-info-row {
    display: flex;
    gap: 2rem;
    font-size: 1rem;
    color: #666;
    align-items: center;
  }
  @media (max-width: 900px) {
    .el-featured-product-section {
      flex-direction: column;
      gap: 2rem;
      padding: 1.2rem 10px;
    }
    .el-featured-product-image {
      padding: 1rem;
    }
  }
</style>

<div class="el-featured-product-section" id="el-featured-product-section">
  <div class="el-featured-product-image">
    <img id="el-featured-product-main-img" src="{{ el_product.selected_or_first_available_variant.featured_image | default: el_product.featured_image | img_url: '600x' }}" alt="{{ el_product.title }}" style="max-width:100%; border-radius:1.5rem;" loading="lazy" />
  </div>
  <div class="el-featured-product-info">
    <div class="el-featured-product-title">{{ el_product.title }}</div>
    <div class="el-featured-product-reviews">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ 12 Reviews</div>
    <div class="el-featured-product-desc">{{ el_product.description | strip_html | truncate: 300 }}</div>
    <div class="el-featured-product-features">
      {% for block in section.blocks %}
        <div class="el-featured-product-feature">
          {% if block.settings.icon != blank %}
            <img src="{{ block.settings.icon | img_url: '40x' }}" alt="icon" style="width:24px;height:24px;object-fit:contain;" loading="lazy" />
          {% endif %}
          <span>{{ block.settings.text }}</span>
        </div>
      {% endfor %}
    </div>
    <form id="el-featured-product-form" action="/cart/add" method="post">
      <input type="hidden" name="id" value="{{ el_product.selected_or_first_available_variant.id }}" />
      <div class="el-featured-product-options">
        {% assign swatch_triggers = section.settings.swatch_triggers | downcase | split: ',' %}
        {% for option in el_product.options_with_values %}
          <label class="el-featured-product-option-label">{{ option.name | upcase }}</label>
          <div class="el-featured-product-swatches" data-option-index="{{ forloop.index0 }}">
            {% assign option_name_downcase = option.name | downcase %}
            {% assign is_trigger = false %}
            {% if swatch_triggers contains option_name_downcase %}
              {% assign is_trigger = true %}
            {% endif %}
            {% for value in option.values %}
              {% assign is_first = forloop.first %}
              {% if is_trigger %}
                <div class="el-featured-product-swatch{% if is_first %} selected{% endif %}"
                  data-value="{{ value }}"
                  data-option-index="{{ forloop.parentloop.index0 }}"
                  tabindex="0"
                  role="button"
                  aria-label="{{ value }}">
                  <span style="background: url('{{ value.variant.image |  image_url: 100  }}'); width: 20px; height: 20px; border-radius: 50%; display: inline-block;"></span>
                  <span class="el-featured-product-tooltip">{{ value }}</span>
                </div>
              {% else %}
                <div class="el-featured-product-pill{% if is_first %} selected{% endif %}" 
                  data-value="{{ value }}"
                  data-option-index="{{ forloop.parentloop.index0 }}"
                  tabindex="0"
                  role="button"
                  aria-label="{{ value }}">
                  {{ value }}
                  <span class="el-featured-product-tooltip">{{ value }}</span>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        {% endfor %}
      </div>
      <div class="el-featured-product-price" id="el-featured-product-price">
        {{ el_product.selected_or_first_available_variant.price | money }}
        {% if el_product.selected_or_first_available_variant.compare_at_price > el_product.selected_or_first_available_variant.price %}
          <span style="font-size:1rem;color:#bc9bb2;margin-left:1rem;">Save {{ el_product.selected_or_first_available_variant.compare_at_price | minus: el_product.selected_or_first_available_variant.price | money }}</span>
        {% endif %}
      </div>
      <button type="submit" class="el-featured-product-atc-btn" id="el-featured-product-atc-btn">A√ëADIR AL CARRITO</button>
    </form>
    <div class="el-featured-product-info-row">
      <span>üöö Env√≠o a todo Colombia</span>
      <span>üõ°Ô∏è Garant√≠a por 30 d√≠as</span>
    </div>
  </div>
</div>

<script>
  window.elRerenderTargets = [
    '#el-featured-product-section',
    // Add more classes/IDs here as needed
  ];
  window.elProductVariants = {{ el_product.variants | json }};
  window.elProductOptions = {{ el_product.options | json }};

  function elFindVariant(selectedOptions) {
    return window.elProductVariants.find(function(variant) {
      return variant.options.every(function(opt, idx) {
        return opt == selectedOptions[idx];
      });
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    var form = document.getElementById('el-featured-product-form');
    var swatchGroups = form.querySelectorAll('.el-featured-product-swatches');
    var selectedOptions = Array.from(window.elProductOptions).map(function(_, i) {
      // Default to first value for each option
      var group = swatchGroups[i];
      if (group) {
        var selected = group.querySelector('.selected');
        if (selected) return selected.getAttribute('data-value');
        var first = group.querySelector('[data-value]');
        if (first) return first.getAttribute('data-value');
      }
      return null;
    });
    var variantInput = form.querySelector('input[name="id"]');
    var atcBtn = document.getElementById('el-featured-product-atc-btn');
    var mainImg = document.getElementById('el-featured-product-main-img');
    var priceBox = document.getElementById('el-featured-product-price');

    // Swatch/pill click logic
    swatchGroups.forEach(function(group, optionIdx) {
      group.querySelectorAll('[data-value]').forEach(function(swatch) {
        swatch.addEventListener('click', function() {
          // Remove selected from siblings
          group.querySelectorAll('[data-value]').forEach(function(s) { s.classList.remove('selected'); });
          swatch.classList.add('selected');
          selectedOptions[optionIdx] = swatch.getAttribute('data-value');
          // Find variant
          var variant = elFindVariant(selectedOptions);
          if (variant) {
            variantInput.value = variant.id;
            // Update price
            if (window.Shopify && window.Shopify.formatMoney) {
              priceBox.innerHTML =
                Shopify.formatMoney(variant.price) +
                (variant.compare_at_price > variant.price ? '<span style="font-size:1rem;color:#bc9bb2;margin-left:1rem;">Save ' + Shopify.formatMoney(variant.compare_at_price - variant.price) + '</span>' : '');
            } else {
              priceBox.innerHTML =
                (variant.price / 100).toLocaleString('es-CO', { style: 'currency', currency: 'COP' }) +
                (variant.compare_at_price > variant.price ? '<span style="font-size:1rem;color:#bc9bb2;margin-left:1rem;">Save ' + ((variant.compare_at_price - variant.price) / 100).toLocaleString('es-CO', { style: 'currency', currency: 'COP' }) + '</span>' : '');
            }
            // Update main image
            if (variant.featured_image && mainImg) {
              mainImg.src = variant.featured_image.src.replace(/(\.[a-z]+)$/, '_600x$1');
            } else if (mainImg) {
              mainImg.src = mainImg.getAttribute('data-default-src');
            }
          }
        });
      });
    });

    // AJAX Add to Cart
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      atcBtn.disabled = true;
      var formData = new FormData(form);
      fetch('/cart/add.js', {
        method: 'POST',
        body: formData,
        headers: { 'Accept': 'application/json' }
      })
      .then(function(res) { return res.json(); })
      .then(function(data) {
        // Rerender targets by fetching 404 page and replacing HTML
        window.elRerenderTargets.forEach(function(selector) {
          fetch('/404')
            .then(function(res) { return res.text(); })
            .then(function(html) {
              var temp = document.createElement('div');
              temp.innerHTML = html;
              var newEl = temp.querySelector(selector);
              var oldEl = document.querySelector(selector);
              if (newEl && oldEl) {
                oldEl.innerHTML = newEl.innerHTML;
              }
            });
        });
        atcBtn.disabled = false;
      })
      .catch(function() { atcBtn.disabled = false; });
    });
  });
</script>

{% schema %}
{
  "name": "EL Featured Product",
  "settings": [
    {
      "type": "product",
      "id": "featured_product",
      "label": "Featured Product"
    },
    {
      "type": "text",
      "id": "swatch_triggers",
      "label": "Swatch Triggers (comma separated option names, e.g. Color,Size)",
      "default": "Color"
    }
  ],
  "blocks": [
    {
      "type": "feature",
      "name": "Feature",
      "settings": [
        {
          "type": "image_picker",
          "id": "icon",
          "label": "Icon Image"
        },
        {
          "type": "text",
          "id": "text",
          "label": "Text",
          "default": "Feature text"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "EL Featured Product",
      "blocks": [
        { "type": "feature" },
        { "type": "feature" },
        { "type": "feature" }
      ]
    }
  ]
}
{% endschema %} 