{% comment %} el-slider: Looping Video Slider Section {% endcomment %}

<style>
.el-slider-container {
  width: 90vw;
  margin: 40px auto;
  overflow: hidden;
  position: relative;
  background: #f6f3f1;
  border-radius: 2rem;
  max-width: 1400px;
}
.el-slider-track {
  display: flex;
  transition: transform 0.5s cubic-bezier(.22,.68,.48,1.02);
  will-change: transform;
}
.el-slide {
  min-width: 20vw;
  max-width: 320px;
  aspect-ratio: .8;
  display: flex;
  align-items: center;
  justify-content: center;
}
.el-slide video, .el-slide img{
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.el-slide.el-slide-active {
  box-shadow: 0 4px 24px #bc9bb2aa;
  z-index: 2;
  /* highlight effect */
}
.el-slider-btn {
  position: absolute;
  bottom: 24px;
  z-index: 2;
  width: 44px;
  height: 44px;
  border-radius: 50%;
  border: 2px solid #dab7d8;
  background: #fff;
  color: #b891b9;
  font-size: 26px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background .2s;
}
.el-slider-btn:hover {
  background: #f3e1f3;
}
.el-slider-prev { left: 45%; transform: translateX(-120%); }
.el-slider-next { right: 45%; transform: translateX(120%); }
@media (max-width: 1100px) {
  .el-slide { min-width: 90vw; max-width: 100vw; }
  .el-slider-container { width: 98vw; }
}
</style>

<div class="el-slider-container">
  {% if section.settings.headline != blank %}
    <h2 style="text-align:center;">{{ section.settings.headline }}</h2>
  {% endif %}
  {% if section.settings.subtitle != blank %}
    <p style="text-align:center;">{{ section.settings.subtitle }}</p>
  {% endif %}
  <div class="el-slider-track" id="elSliderTrack-{{ section.id }}">
    {% for block in section.blocks %}
      <div class="el-slide">
        {% if block.settings.video_url != blank %}
            {%  assign poster_j = block.settings.video_url.preview_image | image_url: width: 600 %}
          {{ block.settings.video_url |  video_tag: autoplay: true, poster: poster_j }}
        {% elsif block.settings.image_url != blank %}
          <img src="{{ block.settings.image_url }}" alt="{{ block.settings.alt | escape }}" style="width:100%;display:block;">
        {% endif %}
      </div>
    {% endfor %}
  </div>
  <button class="el-slider-btn el-slider-prev">&#8592;</button>
  <button class="el-slider-btn el-slider-next">&#8594;</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const sectionId = '{{ section.id }}';
  const track = document.getElementById('elSliderTrack-' + sectionId);
  const slides = Array.from(track.children);
  let slidesToShow = window.innerWidth < 900 ? 1 : 5;
  const slideWidth = slides[0] ? (slides[0].offsetWidth + 36) : 356;

  // Clone last N slides and prepend (in correct order)
  for (let i = slides.length - slidesToShow; i < slides.length; i++) {
    if (slides[i]) track.insertBefore(slides[i].cloneNode(true), track.firstChild);
  }
  // Clone first N slides and append
  for (let i = 0; i < slidesToShow; i++) {
    if (slides[i]) track.appendChild(slides[i].cloneNode(true));
  }

  let currentIndex = slidesToShow;
  function updateSlider() {
    track.style.transform = `translateX(${-currentIndex * slideWidth}px)`;
    // Pause all videos except the active one, and highlight center
    const allSlides = Array.from(track.children);
    allSlides.forEach((slide, idx) => {
      const video = slide.querySelector('video');
      if (video) {
        if (idx === currentIndex) {
          video.play();
        } else {
          video.pause();
        }
      }
      slide.classList.toggle('el-slide-active', idx === currentIndex);
    });
  }
  updateSlider();
  const nextBtn = track.parentElement.querySelector('.el-slider-next');
  const prevBtn = track.parentElement.querySelector('.el-slider-prev');
  nextBtn.onclick = () => {
    currentIndex++;
    updateSlider();
    if (currentIndex === slides.length + slidesToShow) {
      setTimeout(() => {
        track.style.transition = 'none';
        currentIndex = slidesToShow;
        updateSlider();
        track.offsetHeight;
        track.style.transition = '';
      }, 500);
    }
  };
  prevBtn.onclick = () => {
    currentIndex--;
    updateSlider();
    if (currentIndex === 0) {
      setTimeout(() => {
        track.style.transition = 'none';
        currentIndex = slides.length;
        updateSlider();
        track.offsetHeight;
        track.style.transition = '';
      }, 500);
    }
  };
});
</script>

{% schema %}
{
  "name": "El Slider",
  "settings": [
    {
      "type": "text",
      "id": "headline",
      "label": "Headline",
      "default": "Piel real, Resultados reales"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "Lo aplicas en minutos, te dura todo el d√≠a. Ellas te lo muestran."
    }
  ],
  "blocks": [
    {
      "type": "video",
      "name": "Video/Image Slide",
      "settings": [
        {
          "type": "video",
          "id": "video_url",
          "label": "Video"
        },
        {
          "type": "url",
          "id": "image_url",
          "label": "Fallback Image URL"
        },
        {
          "type": "text",
          "id": "alt",
          "label": "Alt Text"
        }
      ]
    }
  ],
  "max_blocks": 12,
  "presets": [
    {
      "name": "El Slider",
      "blocks": [
        { "type": "video", "settings": { "video_url": "", "image_url": "", "alt": "" } },
        { "type": "video", "settings": { "video_url": "", "image_url": "", "alt": "" } },
        { "type": "video", "settings": { "video_url": "", "image_url": "", "alt": "" } }
      ]
    }
  ]
}
{% endschema %} 